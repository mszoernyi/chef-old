<?xml version="1.0"?>
<?xml-stylesheet type="text/xsl" href="configuration.xsl"?>
<%
  @clusters = hadoop2_clusters.select{|cluster_name, cluster| cluster[:nn].size > 0}
  if @clusters.keys.include? node[:hadoop2][:cluster]
    @journal_nodes = @clusters[node[:hadoop2][:cluster]][:jn].map{|jn| "#{jn[:fqdn]}:8485" }.join(";")
  else
    @journal_nodes = nil
  end
%>
<configuration>
  <property>
    <name>dfs.replication.max</name>
    <value>10</value>
  </property>
  <property>
    <name>dfs.replication</name>
    <value>2</value>
  </property>
  <property>
    <name>dfs.permissions.enabled</name>
    <value>false</value>
  </property>
  <property>
    <name>dfs.nameservices</name>
    <value><%= @clusters.keys.join(',') %></value>
  </property>
<% @clusters.each do |cluster_name, cluster| %>
  <property>
    <name>dfs.ha.namenodes.<%= cluster_name %></name>
    <value><%= cluster[:nn].map{ |n| "nn#{n[:cluster][:host][:id]}" }.join(',') %></value>
  </property>
  <% cluster[:nn].each do |n| %>
  <property>
    <name>dfs.namenode.rpc-address.<%= cluster_name %>.nn<%= n[:cluster][:host][:id] %></name>
    <value><%= n[:fqdn] %>:8020</value>
  </property>
  <property>
    <name>dfs.namenode.http-address.<%= cluster_name %>.nn<%= n[:cluster][:host][:id] %></name>
    <value><%= n[:fqdn] %>:50070</value>
  </property>
  <% end %>
  <property>
    <name>dfs.client.failover.proxy.provider.<%= cluster_name %></name>
    <value>org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider</value>
  </property>
<% end %>
<% if @journal_nodes %>
  <property>
    <name>dfs.journalnode.edits.dir</name>
    <value>/var/app/hadoop2/storage/journalnode</value>
  </property>
  <property>
    <name>dfs.namenode.shared.edits.dir</name>
    <value><%= "qjournal://#{@journal_nodes}/#{node[:hadoop2][:cluster]}" %></value>
  </property>
  <property>
    <name>dfs.namenode.name.dir</name>
    <value>file:///var/app/hadoop2/storage/namenode</value>
  </property>
  <property>
    <name>dfs.ha.fencing.methods</name>
    <value>shell(/bin/true)</value>
  </property>
  <property>
    <name>dfs.ha.automatic-failover.enabled</name>
    <value>true</value>
  </property>
  <property>
    <name>dfs.journalnode.edits.dir</name>
    <value>/var/app/hadoop2/storage/journalnode</value>
  </property>  
  <!-- hadoop: <%= node[:hadoop2][:cluster] %> zk: <%= node[:hadoop2][:zk][:cluster] %> -->
  <property>
    <name>ha.zookeeper.quorum</name>
    <value><%= zookeeper_connect('/hadoop2', node[:hadoop2][:zk][:cluster]) %></value>
  </property>
<% end %>
  <property>
    <name>dfs.datanode.data.dir</name>
    <value>file:///var/app/hadoop2/storage/datanode</value>
  </property>
  <property>
    <name>dfs.client.read.shortcircuit</name>
    <value>false</value>
  </property>
  <property>
    <name>dfs.domain.socket.path</name>
    <value>/var/run/hadoop2/dn_socket</value>
  </property>
  <property>
    <name>dfs.datanode.address</name>
    <value>0.0.0.0:50210</value>
  </property>
  <property>
    <name>dfs.datanode.http.address</name>
    <value>0.0.0.0:50275</value>
  </property>
  <property>
    <name>dfs.datanode.address</name>
    <value>0.0.0.0:50210</value>
  </property>
  <property>
    <name>dfs.datanode.ipc.address</name>
    <value>0.0.0.0:50220</value>
  </property>
  <property>
    <name>dfs.datanode.balance.bandwidthPerSec</name>
    <value>5242880</value>
  </property>
  <property>
    <name>dfs.namenode.handler.count</name>
    <value>40</value>
  </property>
  <property>
    <name>dfs.datanode.handler.count</name>
    <value>40</value>
  </property>
</configuration>
